
## 1. Présentation du workflow `deploy.yml`

Voici ton fichier simplifié :

```yaml
name: Deploy Client CMS  
  
on:  
  repository_dispatch:  
    types: [deploy-site]   # Événement déclencheur envoyé par une requête POST à l’API GitHub

  
jobs:  
  build-and-deploy:  
    runs-on: ubuntu-latest  
  
    env:  
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}  
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}  
      SERVER_HOST: ${{ secrets.SERVER_HOST }}  
      SERVER_USER: ${{ secrets.SERVER_USER }}  
      SERVER_PASS: ${{ secrets.SERVER_PASS }}  
  
    steps:  
      - name: Checkout code  
        uses: actions/checkout@v3  
  
      - name: Sanitize titreSite for Docker tag  
        run: |  
          SAFE_TITRE_SITE=$(echo "${{ github.event.client_payload.titreSite }}" | tr '[:upper:]' '[:lower:]' | sed -E 's/ +/-/g')          
          echo "SAFE_TITRE_SITE=$SAFE_TITRE_SITE" >> $GITHUB_ENV  
          
      - name: Build Docker image  
        run: |  
          docker build \            
          --build-arg REACT_APP_PRIMARY="${{ github.event.client_payload.primary }}" \            
          --build-arg REACT_APP_SECONDARY="${{ github.event.client_payload.secondary }}" \            
          --build-arg REACT_APP_TITRE_SITE="${{ github.event.client_payload.titreSite }}" \            
          --build-arg REACT_APP_USER="${{ github.event.client_payload.user }}" \            
          -t $DOCKERHUB_USERNAME/client-cms-$SAFE_TITRE_SITE .  
          
      - name: Log in to Docker Hub  
        run: echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin  
  
      - name: Push Docker image  
        run: docker push $DOCKERHUB_USERNAME/client-cms-$SAFE_TITRE_SITE  
  
      - name: Prepare server (install docker if needed)  
        uses: appleboy/ssh-action@v1.0.0  
        with:  
          host: ${{ env.SERVER_HOST }}  
          username: ${{ env.SERVER_USER }}  
          password: ${{ env.SERVER_PASS }}  
          script: |  
            sudo apt update -y && sudo apt upgrade -y            
            if ! command -v docker &> /dev/null            
			then              
	          curl -fsSL https://get.docker.com | sh            
			fi  
      - name: Run container on server  
        uses: appleboy/ssh-action@v1.0.0  
        with:  
          host: ${{ env.SERVER_HOST }}  
          username: ${{ env.SERVER_USER }}  
          password: ${{ env.SERVER_PASS }}  
          script: |  
            docker stop client-cms-${{ env.SAFE_TITRE_SITE }} || true            
            docker rm client-cms-${{ env.SAFE_TITRE_SITE }} || true            
            docker run -d -p 80:8080 --name client-cms-${{ env.SAFE_TITRE_SITE }} ${{ env.DOCKERHUB_USERNAME }}/client-cms-${{ env.SAFE_TITRE_SITE }}

```

---

