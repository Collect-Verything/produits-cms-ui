

Lorsque lâ€™on dÃ©ploie une application **React** en production, Nginx doit Ãªtre configurÃ© correctement pour :

1. Servir les fichiers statiques gÃ©nÃ©rÃ©s par `npm run build`.
2. GÃ©rer la navigation cÃ´tÃ© client (React Router) â†’ toutes les routes doivent retomber sur `index.html`.
3. Optimiser les performances (cache, compression Gzip).
    

---

## ðŸ”¹ Exemple de `nginx.conf`

```nginx
worker_processes auto;

# PID stockÃ© dans /tmp (nginx-unprivileged nâ€™a pas accÃ¨s Ã  /var/run)
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Logs allÃ©gÃ©s
    access_log off;
    error_log  /dev/stderr warn;

    # Optimisation du transfert
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    keepalive_requests 1000;

    # Compression Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    gzip_min_length 256;
    gzip_vary on;

    server {
        listen       8080;
        server_name  localhost;

        # RÃ©pertoire oÃ¹ CRA gÃ©nÃ¨re les fichiers buildÃ©s
        root /usr/share/nginx/html;
        index index.html;

        # --- Route principale ---
        location / {
            # Si fichier existe â†’ le servir
            # Sinon â†’ rediriger vers index.html (React Router)
            try_files $uri /index.html;
        }

        # --- Fichiers statiques ---
        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg|map)$ {
            expires 1y;
            access_log off;
            add_header Cache-Control "public, immutable";
        }

        # --- RÃ©pertoires spÃ©cifiques ---
        location /static/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

---

## ðŸ”¹ Explications

### 1. **Gestion des routes React Router**

- React Router est un **router cÃ´tÃ© client**.
- Exemple : si lâ€™utilisateur visite `/dashboard`, Nginx ne connaÃ®t pas cette route.
- Sans configuration, Nginx renvoie une **404**.
- Avec :
    
    ```nginx
    try_files $uri /index.html;
    ```
    
    â†’ si le fichier nâ€™existe pas, Nginx renvoie `index.html`.  
    â†’ React Router prend ensuite le relais et affiche la bonne page.
    

---

### 2. **Gestion des fichiers statiques**

- Les fichiers comme `.css`, `.js`, `.png`, `.svg`, etc. sont gÃ©nÃ©rÃ©s avec un hash unique (`main.abc123.js`).
- On peut donc les mettre en cache **1 an** cÃ´tÃ© navigateur :
    
    ```nginx
    expires 1y;
    add_header Cache-Control "public, immutable";
    ```
- RÃ©sultat : meilleures performances au rechargement.
    

---

### 3. **Compression Gzip**

- Active la compression HTTP pour rÃ©duire la taille des fichiers envoyÃ©s.
- SupportÃ©e par tous les navigateurs modernes.
- Exemple : un bundle de 500 KB peut descendre Ã  150 KB.
    

---

### 4. **Nginx unprivileged**

- Lâ€™image `nginxinc/nginx-unprivileged` tourne sans droits root.
- Le fichier `pid` est stockÃ© dans `/tmp/nginx.pid`.
- SÃ©curitÃ© renforcÃ©e â†’ moins de surface dâ€™attaque.
    

---

## ðŸ”¹ RÃ©sumÃ©

- **`try_files $uri /index.html;`** = indispensable pour React Router.
- **Cache long (1y)** = optimisation des performances.
- **gzip** = rÃ©duction de la bande passante.
- **nginx-unprivileged** = sÃ©curitÃ© renforcÃ©e.
    

ðŸ‘‰ Ce `nginx.conf` est donc adaptÃ© pour servir une **Single Page Application (SPA)** React de maniÃ¨re **rapide, sÃ»re et compatible avec React Router**.



### More


# ðŸ”Ž Explication complÃ¨te du `nginx.conf`

```nginx
worker_processes auto;
```

ðŸ‘‰ DÃ©finit combien de processus workers Nginx doit lancer.

- `auto` = Nginx choisit en fonction du nombre de CPU disponibles.
- Plus de workers = meilleure capacitÃ© Ã  gÃ©rer des connexions simultanÃ©es.
    

---

```nginx
pid /tmp/nginx.pid;
```

ðŸ‘‰ Emplacement du fichier **PID** du processus principal Nginx.

- Par dÃ©faut, câ€™est `/var/run/nginx.pid`, mais comme lâ€™image `nginx-unprivileged` nâ€™a pas accÃ¨s Ã  `/var/run`, on le met dans `/tmp`.
    

---

```nginx
events {
    worker_connections 1024;
}
```

ðŸ‘‰ DÃ©finit le nombre maximum de connexions simultanÃ©es par worker.

- Ici : **1024 connexions par worker**.
- En prod, Ã§a peut Ãªtre ajustÃ© selon la charge attendue.
    

---

```nginx
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
```

ðŸ‘‰ Bloc `http` = configuration globale du serveur HTTP.

- `include /etc/nginx/mime.types` â†’ mappe les extensions de fichiers aux bons `Content-Type` (ex: `.css â†’ text/css`).
- `default_type application/octet-stream` â†’ type par dÃ©faut si non reconnu (fichier binaire).
    

---

```nginx
    access_log off;
    error_log  /dev/stderr warn;
```

ðŸ‘‰ Logs de Nginx.

- `access_log off` â†’ dÃ©sactive les logs des requÃªtes (rÃ©duit les I/O).
- `error_log /dev/stderr warn` â†’ les erreurs sont envoyÃ©es sur la sortie standard dâ€™erreur du conteneur (visible via `docker logs`).
- Niveau `warn` â†’ affiche seulement les warnings et erreurs.
    

---

```nginx
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    keepalive_requests 1000;
```

ðŸ‘‰ Optimisations rÃ©seau.

- `sendfile on` â†’ envoie les fichiers statiques directement depuis le kernel (rapide).
- `tcp_nopush on` â†’ envoie les en-tÃªtes HTTP dans un seul paquet (optimisation).
- `tcp_nodelay on` â†’ Ã©vite les dÃ©lais dans lâ€™envoi des petites rÃ©ponses.
- `keepalive_timeout 65` â†’ garde les connexions ouvertes 65s pour les rÃ©utiliser.
- `keepalive_requests 1000` â†’ limite de requÃªtes max par connexion keepalive.
    

---

```nginx
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
    gzip_min_length 256;
    gzip_vary on;
```

ðŸ‘‰ Compression HTTP avec Gzip.

- `gzip on` â†’ active la compression.
- `gzip_types` â†’ types de contenu compressÃ©s.
- `gzip_min_length 256` â†’ seulement les fichiers > 256 octets sont compressÃ©s.
- `gzip_vary on` â†’ ajoute lâ€™en-tÃªte `Vary: Accept-Encoding` (bonnes pratiques cache).
    

---

```nginx
    server {
        listen       8080;
        server_name  localhost;
```

ðŸ‘‰ Bloc `server` = configuration dâ€™un serveur virtuel.

- `listen 8080` â†’ Ã©coute sur le port **8080** (dans Docker, on mappe `-p 80:8080`).
- `server_name localhost` â†’ nom du serveur (ici juste `localhost`).
    

---

```nginx
        root /usr/share/nginx/html;
        index index.html;
```

ðŸ‘‰ DÃ©finit le rÃ©pertoire oÃ¹ CRA met son `build/`.

- `root` â†’ chemin des fichiers statiques (`/usr/share/nginx/html`).
- `index` â†’ fichier par dÃ©faut si aucun nâ€™est spÃ©cifiÃ© dans lâ€™URL (`index.html`).
    

---

```nginx
        location / {
            try_files $uri /index.html;
        }
```

ðŸ‘‰ RÃ¨gle critique pour **React Router**.

- Si le fichier demandÃ© existe (`$uri`), Nginx le sert.
- Sinon â†’ redirige vers `index.html`.
- Exemple : `/dashboard` â†’ pas de fichier `/dashboard` â†’ Nginx renvoie `index.html` â†’ React Router affiche la bonne page.
    

---

```nginx
        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|ttf|svg|map)$ {
            expires 1y;
            access_log off;
            add_header Cache-Control "public, immutable";
        }
```

ðŸ‘‰ Cache des fichiers statiques.

- `~*` â†’ regex insensible Ã  la casse.
- Extensions ciblÃ©es : `.css`, `.js`, `.png`, `.svg`, etc.
- `expires 1y` â†’ dit au navigateur de garder le fichier en cache **1 an**.
- `Cache-Control: public, immutable` â†’ garantit que le fichier ne changera pas (car CRA gÃ©nÃ¨re des noms de fichiers hashÃ©s).
    

---

```nginx
        location /static/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
```

ðŸ‘‰ RÃ¨gle spÃ©cifique pour le dossier `/static/`.

- CRA met tous les fichiers buildÃ©s hashÃ©s dans `/static/`.
- Ici aussi â†’ cache long (1 an).
    

---

# âœ… RÃ©sumÃ©

Ton `nginx.conf` fait donc :

1. **Ã‰coute sur le port 8080** (mappÃ© sur 80 en prod).
2. Sert les fichiers buildÃ©s dans `/usr/share/nginx/html`.
3. **Support SPA** : grÃ¢ce Ã  `try_files`, toutes les routes retombent sur `index.html`.
4. **Performances** :
    - `sendfile`, `keepalive`, `gzip`.
    - Cache long pour les assets (`Cache-Control immutable`).
5. **SÃ©curitÃ©** : logs rÃ©duits + image `nginx-unprivileged` (pas root).
    
