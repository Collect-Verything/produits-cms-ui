
### ğŸ”¹ 1. **DÃ©clencheur (`repository_dispatch`)**

- Le workflow sâ€™exÃ©cute quand une requÃªte POST est envoyÃ©e Ã  lâ€™API GitHub : 

(checker doc 5.4 pour effectuer cette requete sur une app en prod)

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <TOKEN>" \
  https://api.github.com/repos/<org>/<repo>/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```

- **`event_type`** = `deploy-site` (doit correspondre au `types: [deploy-site]`).
- **`client_payload`** = donnÃ©es envoyÃ©es par le frontend (variables dynamiques).
    

ğŸ‘‰ Exemple dâ€™usage : un utilisateur configure son site â†’ envoi dâ€™une requÃªte â†’ dÃ©clenchement du pipeline.

----
### ğŸ”¹ 1.2 **ğŸ§¹ Sanitize des variables pour Docker dans GitHub Actions

Quand on utilise des valeurs dynamiques (ex. `titreSite`) pour nommer des images ou conteneurs Docker, il faut **nettoyer (sanitize)** ces valeurs :

- Docker refuse certains caractÃ¨res (`@`, espaces, majuscules, accents, etc.).
    
- Les noms dâ€™images et de tags doivent Ãªtre en **minuscule** et sans caractÃ¨res spÃ©ciaux.
    

ğŸ‘‰ Exemple de step dans ton workflow :

```yaml
- name: Sanitize titreSite for Docker tag
  run: |
    SAFE_TITRE_SITE=$(echo "${{ github.event.client_payload.titreSite }}" \
      | tr '[:upper:]' '[:lower:]' \
      | sed -E 's/ +/-/g')
    echo "SAFE_TITRE_SITE=$SAFE_TITRE_SITE" >> $GITHUB_ENV
```

---

### ğŸ” Explication de la commande

1. `echo "${{ github.event.client_payload.titreSite }}"`  
    â†’ rÃ©cupÃ¨re la valeur envoyÃ©e par ton `repository_dispatch` (ex. `"Ma Boutique Test"`).
    
2. `tr '[:upper:]' '[:lower:]'`  
    â†’ transforme toutes les majuscules en minuscules (`Ma Boutique` â†’ `ma boutique`).
    
3. `sed -E 's/ +/-/g'`  
    â†’ remplace chaque groupe dâ€™espaces par un tiret (`ma boutique test` â†’ `ma-boutique-test`).
    
4. `echo "SAFE_TITRE_SITE=$SAFE_TITRE_SITE" >> $GITHUB_ENV`  
    â†’ Ã©crit la nouvelle variable dans le fichier dâ€™environnement interne Ã  GitHub Actions.
    
    - RÃ©sultat : `SAFE_TITRE_SITE` devient une variable globale **disponible pour les steps suivants** du job.
        

---

### ğŸ“¦ Utilisation dans les steps suivants

Une fois cette Ã©tape exÃ©cutÃ©e, tu peux utiliser la variable :

- Dans un script **bash exÃ©cutÃ© sur la VM GitHub Actions** :
    
    ```bash
    echo $SAFE_TITRE_SITE
    # â†’ ma-boutique-test
    ```
    
- Dans les expressions GitHub Actions (ex. SSH ou Docker) :
    
    ```yaml
    docker run -d --name client-cms-${{ env.SAFE_TITRE_SITE }} \
      ${{ env.DOCKERHUB_USERNAME }}/client-cms-${{ env.SAFE_TITRE_SITE }}
    ```
    

---

### âš¡ DiffÃ©rence clÃ© : `$SAFE_TITRE_SITE` vs `${{ env.SAFE_TITRE_SITE }}`

- `$SAFE_TITRE_SITE`  
    â†’ InterprÃ©tÃ© par **bash** directement dans un script qui tourne sur la VM GitHub Actions.  
    ğŸ‘‰ Marche uniquement **dans les steps locaux**.
    
- `${{ env.SAFE_TITRE_SITE }}`  
    â†’ InterprÃ©tÃ© par **le moteur GitHub Actions** avant dâ€™envoyer les commandes (ex. via `ssh-action`).  
    ğŸ‘‰ Obligatoire quand tu veux que la valeur soit remplacÃ©e **avant dâ€™Ãªtre envoyÃ©e au VPS**.
    
### ğŸ”¹ 2. **Build de lâ€™image**

```yaml
docker build \
  --build-arg REACT_APP_PRIMARY="${{ github.event.client_payload.primary }}" \
  --build-arg REACT_APP_SECONDARY="${{ github.event.client_payload.secondary }}" \
  --build-arg REACT_APP_TITRE_SITE="${{ github.event.client_payload.titreSite }}" \
  --build-arg REACT_APP_USER="${{ github.event.client_payload.user }}" \
  -t $DOCKERHUB_USERNAME/client-cms-${{ github.event.client_payload.user }} .
```

- On injecte les paramÃ¨tres du **payload** directement comme `--build-arg`.
- Lâ€™image est taggÃ©e de maniÃ¨re unique grÃ¢ce Ã  `client_payload.user`.  
    ğŸ‘‰ Exemple : `cansefr/client-cms-usertest`.
    

---

### ğŸ”¹ 3. **Push sur Docker Hub**

```yaml
echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
docker push $DOCKERHUB_USERNAME/client-cms-${{ github.event.client_payload.user }}
```

- Connexion au Docker Hub avec un **token stockÃ© dans GitHub Secrets**.
- Push de lâ€™image buildÃ©e â†’ disponible depuis ton VPS.
    

---

### ğŸ”¹ 4. **Connexion au serveur & installation de Docker**

```yaml
sudo apt update -y && sudo apt upgrade -y
if ! command -v docker &> /dev/null
then
  curl -fsSL https://get.docker.com | sh
fi
```

- Si Docker nâ€™est pas installÃ© sur le VPS â†’ installation automatique.
- Garantit que le serveur est prÃªt Ã  exÃ©cuter lâ€™image.
    

---

### ğŸ”¹ 5. **DÃ©ploiement & lancement du conteneur**

```yaml
docker stop client-cms-${{ github.event.client_payload.user }} || true
docker rm client-cms-${{ github.event.client_payload.user }} || true
docker run -d -p 80:8080 \
  --name client-cms-${{ github.event.client_payload.user }} \
  $DOCKERHUB_USERNAME/client-cms-${{ github.event.client_payload.user }}
```

- ArrÃªte et supprime tout ancien conteneur du mÃªme nom.
- Lance une nouvelle instance sur **port 80 (hÃ´te)** â†’ **8080 (Nginx)**.
- Le conteneur est nommÃ© dynamiquement (`client-cms-usertest`).
    

ğŸ‘‰ RÃ©sultat : chaque utilisateur peut avoir sa propre version isolÃ©e de lâ€™app.
