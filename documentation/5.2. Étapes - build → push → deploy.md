
### 🔹 1. **Déclencheur (`repository_dispatch`)**

- Le workflow s’exécute quand une requête POST est envoyée à l’API GitHub : 

(checker doc 5.4 pour effectuer cette requete sur une app en prod)

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <TOKEN>" \
  https://api.github.com/repos/<org>/<repo>/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```

- **`event_type`** = `deploy-site` (doit correspondre au `types: [deploy-site]`).
- **`client_payload`** = données envoyées par le frontend (variables dynamiques).
    

👉 Exemple d’usage : un utilisateur configure son site → envoi d’une requête → déclenchement du pipeline.

----
### 🔹 1.2 **🧹 Sanitize des variables pour Docker dans GitHub Actions

Quand on utilise des valeurs dynamiques (ex. `titreSite`) pour nommer des images ou conteneurs Docker, il faut **nettoyer (sanitize)** ces valeurs :

- Docker refuse certains caractères (`@`, espaces, majuscules, accents, etc.).
    
- Les noms d’images et de tags doivent être en **minuscule** et sans caractères spéciaux.
    

👉 Exemple de step dans ton workflow :

```yaml
- name: Sanitize titreSite for Docker tag
  run: |
    SAFE_TITRE_SITE=$(echo "${{ github.event.client_payload.titreSite }}" \
      | tr '[:upper:]' '[:lower:]' \
      | sed -E 's/ +/-/g')
    echo "SAFE_TITRE_SITE=$SAFE_TITRE_SITE" >> $GITHUB_ENV
```

---

### 🔍 Explication de la commande

1. `echo "${{ github.event.client_payload.titreSite }}"`  
    → récupère la valeur envoyée par ton `repository_dispatch` (ex. `"Ma Boutique Test"`).
    
2. `tr '[:upper:]' '[:lower:]'`  
    → transforme toutes les majuscules en minuscules (`Ma Boutique` → `ma boutique`).
    
3. `sed -E 's/ +/-/g'`  
    → remplace chaque groupe d’espaces par un tiret (`ma boutique test` → `ma-boutique-test`).
    
4. `echo "SAFE_TITRE_SITE=$SAFE_TITRE_SITE" >> $GITHUB_ENV`  
    → écrit la nouvelle variable dans le fichier d’environnement interne à GitHub Actions.
    
    - Résultat : `SAFE_TITRE_SITE` devient une variable globale **disponible pour les steps suivants** du job.
        

---

### 📦 Utilisation dans les steps suivants

Une fois cette étape exécutée, tu peux utiliser la variable :

- Dans un script **bash exécuté sur la VM GitHub Actions** :
    
    ```bash
    echo $SAFE_TITRE_SITE
    # → ma-boutique-test
    ```
    
- Dans les expressions GitHub Actions (ex. SSH ou Docker) :
    
    ```yaml
    docker run -d --name client-cms-${{ env.SAFE_TITRE_SITE }} \
      ${{ env.DOCKERHUB_USERNAME }}/client-cms-${{ env.SAFE_TITRE_SITE }}
    ```
    

---

### ⚡ Différence clé : `$SAFE_TITRE_SITE` vs `${{ env.SAFE_TITRE_SITE }}`

- `$SAFE_TITRE_SITE`  
    → Interprété par **bash** directement dans un script qui tourne sur la VM GitHub Actions.  
    👉 Marche uniquement **dans les steps locaux**.
    
- `${{ env.SAFE_TITRE_SITE }}`  
    → Interprété par **le moteur GitHub Actions** avant d’envoyer les commandes (ex. via `ssh-action`).  
    👉 Obligatoire quand tu veux que la valeur soit remplacée **avant d’être envoyée au VPS**.
    
### 🔹 2. **Build de l’image**

```yaml
docker build \
  --build-arg REACT_APP_PRIMARY="${{ github.event.client_payload.primary }}" \
  --build-arg REACT_APP_SECONDARY="${{ github.event.client_payload.secondary }}" \
  --build-arg REACT_APP_TITRE_SITE="${{ github.event.client_payload.titreSite }}" \
  --build-arg REACT_APP_USER="${{ github.event.client_payload.user }}" \
  -t $DOCKERHUB_USERNAME/client-cms-${{ github.event.client_payload.user }} .
```

- On injecte les paramètres du **payload** directement comme `--build-arg`.
- L’image est taggée de manière unique grâce à `client_payload.user`.  
    👉 Exemple : `cansefr/client-cms-usertest`.
    

---

### 🔹 3. **Push sur Docker Hub**

```yaml
echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin
docker push $DOCKERHUB_USERNAME/client-cms-${{ github.event.client_payload.user }}
```

- Connexion au Docker Hub avec un **token stocké dans GitHub Secrets**.
- Push de l’image buildée → disponible depuis ton VPS.
    

---

### 🔹 4. **Connexion au serveur & installation de Docker**

```yaml
sudo apt update -y && sudo apt upgrade -y
if ! command -v docker &> /dev/null
then
  curl -fsSL https://get.docker.com | sh
fi
```

- Si Docker n’est pas installé sur le VPS → installation automatique.
- Garantit que le serveur est prêt à exécuter l’image.
    

---

### 🔹 5. **Déploiement & lancement du conteneur**

```yaml
docker stop client-cms-${{ github.event.client_payload.user }} || true
docker rm client-cms-${{ github.event.client_payload.user }} || true
docker run -d -p 80:8080 \
  --name client-cms-${{ github.event.client_payload.user }} \
  $DOCKERHUB_USERNAME/client-cms-${{ github.event.client_payload.user }}
```

- Arrête et supprime tout ancien conteneur du même nom.
- Lance une nouvelle instance sur **port 80 (hôte)** → **8080 (Nginx)**.
- Le conteneur est nommé dynamiquement (`client-cms-usertest`).
    

👉 Résultat : chaque utilisateur peut avoir sa propre version isolée de l’app.
