

GitHub propose un mécanisme spécial pour déclencher un workflow en dehors de GitHub UI ou des événements Git standards :  
l’**événement `repository_dispatch`**.  
Cet événement est invoqué via l’API REST de GitHub en envoyant une requête POST sur l’endpoint `/dispatches`.

---

## 7.1. Endpoint GitHub REST API `/dispatches`

- URL générale :
    

```
POST https://api.github.com/repos/:owner/:repo/dispatches
```

- Headers obligatoires :
    
    - `Accept: application/vnd.github+json`
        
    - `Authorization: Bearer <PAT>`
        
- Body attendu :
    

```json
{
  "event_type": "nom-evenement",
  "client_payload": {
    "clé1": "valeur1",
    "clé2": "valeur2"
  }
}
```

👉 Ici :

- `event_type` doit correspondre à ce que tu as défini dans ton `on.repository_dispatch.types` du workflow (`deploy-site` dans ton cas).
    
- `client_payload` est un objet libre qui sera injecté dans le workflow (accessible via `github.event.client_payload`).
    

---

## 7.2. Exemple de requête `curl` (avec `client_payload`)

Exemple concret adapté à ton projet :

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <DEPLOY_PAT>" \
  https://api.github.com/repos/Collect-Verything/produits-cms-ui/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```

👉 Points importants :

- `<DEPLOY_PAT>` doit être un **Personal Access Token (PAT)** correctement configuré (voir fiche **6. Bearer Token GitHub**).
    
- `user` sert à générer un nom unique d’image Docker et de conteneur (`client-cms-usertest`).
    
- La réponse de l’API ne contient pas de détails → il faut analyser le **code HTTP** pour savoir ce qui s’est passé.
    

---

## 7.3. Vérification des réponses HTTP

GitHub API ne renvoie pas de corps détaillé sur `/dispatches`, seulement un **status code**.  
Voici les cas possibles :

- **204 No Content ✅**
    
    - Le workflow a bien été déclenché.
        
    - Tu peux vérifier dans **Actions → onglet workflow** sur GitHub que le job s’exécute.
        
- **401 Unauthorized ❌**
    
    - Ton PAT est invalide ou expiré.
        
    - Vérifie la fiche **6. Bearer Token GitHub (6.5 Vérifications)** → utilise `curl https://api.github.com/user` pour tester le token.
        
- **403 Forbidden ❌**
    
    - Ton PAT n’a pas les bonnes permissions.
        
    - Voir fiche **6.3 Droits & permissions minimales** → il faut `Actions: Read and write` et `Contents: Read and write`.
        
- **404 Not Found ❌**
    
    - Le repo est privé ou l’owner est incorrect.
        
    - Vérifie :
        
        - le bon **namespace** (`Collect-Verything` et pas ton compte perso).
            
        - que ton PAT a bien accès au repo (voir fiche **6.5 Vérifications et checks utiles**).
            

---

## ✅ Résumé

- L’endpoint `/dispatches` permet de **déclencher un workflow par API**.
    
- Tu dois fournir un **PAT valide** + un **event_type** correspondant.
    
- Les variables envoyées dans `client_payload` sont directement exploitables dans ton workflow (`github.event.client_payload.*`).
    
- Les réponses HTTP (`204`, `401`, `403`, `404`) permettent de diagnostiquer rapidement → se référer à la fiche **6. Bearer Token GitHub** pour résoudre les cas d’erreurs.
    

---

⚡ En pratique : **204** = succès, tout le reste → problème de token, repo ou permissions.
