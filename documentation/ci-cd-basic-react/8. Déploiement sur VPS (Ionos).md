

Le déploiement sur un VPS implique non seulement l’installation et le lancement de Docker, mais aussi la gestion des **firewalls** et du **mapping de ports**. Avec Ionos, il faut bien comprendre la distinction entre firewall **externe (console Ionos)** et firewall **interne (sur ton VPS via UFW)**.

---

## 8.1. Firewall externe Ionos (ports 80/443)

- Sur l’interface **Ionos**, chaque VPS dispose d’un firewall externe (appelé “pare-feu réseau”).
- Par défaut, seuls certains ports sont ouverts (`22` pour SSH, parfois `80`/`443`).
- Si tu lances ton conteneur avec un port **non ouvert** (ex: `8080`), tu ne verras rien depuis ton navigateur → le trafic est bloqué en amont.

👉 Pour une application web, il faut :
- **Ouvrir le port 80 (HTTP)**
- **Ouvrir le port 443 (HTTPS)** si tu ajoutes SSL (via certbot/nginx).
    

⚠️ Pas besoin d’ouvrir `8080` si tu fais un mapping vers `80` (voir 8.3).
Ionos possede deja une config de par feu de base contrairement a un aws ec2 par exemple pour le qul il faut parametrer et creer un ou des groupes de securités

---

## 8.2. Firewall interne (UFW)

- Ton VPS (Ubuntu, Debian, etc.) peut avoir un firewall interne comme **UFW**.
- Si UFW est activé, il faut aussi y autoriser les ports.
    

Exemple :

```bash
# Vérifier l’état
sudo ufw status

# Autoriser HTTP et HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# (optionnel) autoriser un port spécifique si nécessaire
sudo ufw allow 8080/tcp
```

👉 Même si tu ouvres le port côté Ionos, si UFW le bloque sur ton VPS → impossible d’y accéder. ( a voire ... )

---

## 8.3. Mapping des ports (`-p 80:8080`)

Ton application React est servie par **Nginx dans le conteneur** → et ce Nginx écoute sur le **port 8080 interne** (défini dans `nginx.conf`).

Pour la rendre accessible depuis l’extérieur :

```bash
docker run -d -p 80:8080 client-cms
```

- `80:8080` → redirige le **port 80 de l’hôte (VPS)** vers le **port 8080 interne du conteneur**.
    
- Résultat :
    
    - Depuis ton navigateur → tu accèdes via `http://<IP_SERVEUR>` (port 80).
        
    - En interne → la requête est renvoyée vers Nginx qui écoute sur `8080`.
        

👉 Cela permet d’utiliser les **ports standards du web (80/443)** tout en gardant une config Nginx classique sur `8080`.

---

## 8.4. Commandes SSH pour lancer/arrêter un conteneur

Depuis ton VPS (via SSH `ssh user@ip`), voici les commandes utiles :

### 🔹 Lancer un conteneur

```bash
docker run -d --name client-cms-usertest -p 80:8080 client-cms-usertest
```

- `-d` → mode détaché (le conteneur tourne en arrière-plan).
    
- `--name` → donne un nom explicite (pratique pour l’arrêter/redémarrer).
    
- `-p 80:8080` → mapping port hôte/containeur.
    
- `client-cms-usertest` → image Docker (locale ou récupérée de Docker Hub).
    

---

### 🔹 Vérifier les conteneurs actifs

```bash
docker ps
```

Affiche les conteneurs en cours d’exécution, leurs noms, et les ports exposés.

---

### 🔹 Arrêter un conteneur

```bash
docker stop client-cms-usertest
```

Arrête proprement le conteneur.

---

### 🔹 Supprimer un conteneur

```bash
docker rm client-cms-usertest
```

⚠️ Un conteneur doit être arrêté avant d’être supprimé.

---

### 🔹 Re-déployer (pattern courant)

Souvent utilisé dans les scripts CI/CD :

```bash
docker stop client-cms-usertest || true
docker rm client-cms-usertest || true
docker run -d --name client-cms-usertest -p 80:8080 client-cms-usertest
```

- `|| true` → évite que le script échoue si le conteneur n’existe pas encore.
    
- Cela permet de **toujours repartir sur un conteneur neuf** avec la dernière image buildée.
    

---

## ✅ Résumé

- Ionos possède un **firewall externe** → il faut ouvrir **80/443** (et pas 8080).
    
- Le VPS peut avoir un firewall interne (**UFW**) → vérifier et autoriser les ports.
    
- Le mapping `-p 80:8080` permet d’exposer ton app sur `http://<ip>` sans devoir utiliser `:8080` dans l’URL.
    
- Les commandes Docker à connaître : `run`, `ps`, `stop`, `rm`.
    
- Le cycle complet de déploiement sur VPS = **pull image → stop ancien conteneur → run nouveau conteneur**.
    
