
En mode **production**, l‚Äôobjectif est de construire une version optimis√©e de l‚Äôapplication React (avec `npm run build`) et de la servir via **Nginx**.  
On utilise un **multi-stage build** pour s√©parer la phase de build (Node.js) et la phase de runtime (Nginx).

---

## üîπ Contenu du `Dockerfile`

```dockerfile
# =========================================
# Stage 1: Build the React.js Application
# =========================================
ARG NODE_VERSION=22.14.0-alpine
ARG NGINX_VERSION=alpine3.21
FROM node:${NODE_VERSION} AS builder
WORKDIR /app

# Copier les fichiers de d√©pendances
COPY package.json package-lock.json ./

# D√©finir les variables d'environnement (inject√©es via --build-arg)
ARG REACT_APP_PRIMARY
ENV REACT_APP_PRIMARY=${REACT_APP_PRIMARY}

ARG REACT_APP_SECONDARY
ENV REACT_APP_SECONDARY=${REACT_APP_SECONDARY}

ARG REACT_APP_TITRE_SITE
ENV REACT_APP_TITRE_SITE=${REACT_APP_TITRE_SITE}

ARG REACT_APP_USER
ENV REACT_APP_USER=${REACT_APP_USER}

# Installer les d√©pendances
RUN --mount=type=cache,target=/root/.npm npm ci

# Copier le reste du code et builder l'app
COPY ../../../../Doc-Obs/React/CI-CD .
RUN npm run build

# =========================================
# Stage 2: Serve React with Nginx
# =========================================
FROM nginxinc/nginx-unprivileged:${NGINX_VERSION} AS runner
USER nginx

# Copier la config Nginx
COPY nginx.conf /etc/nginx/nginx.conf

# Copier le build React depuis l‚Äô√©tape pr√©c√©dente
COPY --chown=nginx:nginx --from=builder /app/build /usr/share/nginx/html

# Exposer le port 8080 (interne au conteneur)
EXPOSE 8080

# D√©marrer Nginx
ENTRYPOINT ["nginx", "-c", "/etc/nginx/nginx.conf"]
CMD ["-g", "daemon off;"]
```

---

## üîπ Explications

### √âtape 1 : Build (Node.js)

- Bas√©e sur une image **Node.js Alpine** (l√©g√®re).
    
- Installation des d√©pendances avec `npm ci`.
    
- Ex√©cution de `npm run build` ‚Üí g√©n√®re un dossier `build/` optimis√©.
    
- Les variables d‚Äôenvironnement `REACT_APP_*` sont inject√©es avec `--build-arg` ‚Üí elles sont **fig√©es dans le code compil√©**.
    

### √âtape 2 : Runtime (Nginx)

- Utilise **nginxinc/nginx-unprivileged**, une image Nginx sans root (s√©curit√©).
    
- Le dossier `build/` est copi√© dans `/usr/share/nginx/html`.
    
- `nginx.conf` d√©finit comment Nginx sert les fichiers statiques.
    
- Le conteneur expose le port **8080** (interne), qu‚Äôon peut mapper sur le port **80** du serveur.
    

---

## üîπ Commandes utiles

### Construire l‚Äôimage (avec variables d‚Äôenv au build) :

```bash
docker build \
  --build-arg REACT_APP_PRIMARY="#f542c2" \
  --build-arg REACT_APP_SECONDARY="#fcba03" \
  --build-arg REACT_APP_TITRE_SITE="titretest" \
  --build-arg REACT_APP_USER="usertest" \
  -t client-cms .
```

### Lancer le conteneur en production :

```bash
docker run -p 80:8080 client-cms
```

üëâ Application dispo sur [http://localhost](http://localhost/).

---

## üîπ Avantages du multi-stage build

- **Taille r√©duite** : seule l‚Äôimage Nginx finale est livr√©e (pas de Node.js inutile en prod).
    
- **S√©curit√© accrue** : conteneur bas√© sur Nginx non-root.
    
- **Performances** : Nginx est optimis√© pour servir des fichiers statiques (bien plus rapide que Node.js).
    
- **Flexibilit√©** : possibilit√© de personnaliser `nginx.conf` (cache, compression, SPA routing).
    

---

‚úÖ Ce `Dockerfile` est donc ta **recette finale pour la prod**, combinant build React + Nginx, pr√™te √† √™tre d√©ploy√©e sur un serveur VPS ou via GitHub Actions.
