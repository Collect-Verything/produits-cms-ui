

## 6.1. Pourquoi un PAT est nÃ©cessaire

Un **Personal Access Token (PAT)** est requis car :

- Ton dÃ©pÃ´t est **privÃ©** â†’ une simple requÃªte HTTP anonyme (`curl`) renvoie `404 Not Found`.
- Le workflow est dÃ©clenchÃ© via un **Ã©vÃ©nement `repository_dispatch`**, donc on doit **authentifier** la requÃªte auprÃ¨s de lâ€™API GitHub.
- Lâ€™authentification standard (login/mdp) nâ€™existe plus â†’ seul un **Bearer Token** (PAT) est acceptÃ©.

ğŸ‘‰ Sans PAT ou avec un PAT mal configurÃ© â†’ erreurs frÃ©quentes :

- `401 Unauthorized` â†’ mauvais token ou expirÃ©.
- `403 Resource not accessible by personal access token` â†’ manque de permissions.
- `404 Not Found` â†’ repo privÃ© inaccessible au token.
    

---

## 6.2. CrÃ©ation dâ€™un PAT fine-grained

GitHub recommande dâ€™utiliser des **fine-grained tokens** (plus sÃ©curisÃ©s que les anciens "classic PAT").

â¡ï¸ Ã‰tapes :

1. Aller sur : [https://github.com/settings/tokens?type=beta](https://github.com/settings/tokens?type=beta)
2. **Token name** : ex. `client-deploy`.
3. **Expiration** : mettre une durÃ©e raisonnable (Ã©viter "No expiration").
4. **Resource owner** :
    - Choisir ton **organisation (`Collect-Verything`)**, pas seulement ton compte perso.
    - Sinon â†’ tu auras un `403` sur les repos privÃ©s de lâ€™orga.
5. **Repository access** :
    - **Only select repositories** â†’ sÃ©lectionner `produits-cms-ui`.
    - Ã‰vite "All repositories" si inutile.
        

---

## 6.3. Droits & permissions minimales

Pour que le token permette de dÃ©clencher le workflow, il faut activer les droits suivants :

### ğŸ”¹ Repository permissions

- **Actions â†’ Read and write** âœ… (pour autoriser le dÃ©clenchement de workflows).
- **Contents â†’ Read and write** âœ… (pour accÃ©der au code si besoin pendant le workflow).
- **Metadata â†’ Read-only** âœ… (obligatoire par dÃ©faut, rien Ã  changer).
    

### ğŸ”¹ Organization permissions

- Pas nÃ©cessaire ici (sauf si tu veux gÃ©rer dâ€™autres aspects globaux de lâ€™orga).
    

ğŸ‘‰ Sans `Actions: Read and write`, tu auras :

```json
{ "message": "Resource not accessible by personal access token", "status": 403 }
```

ğŸ‘‰ Sans `Contents: Read and write`, tu ne pourras pas `checkout` le code dans ton workflow.

---

## 6.4. Ajout en secret GitHub Actions

Une fois ton PAT gÃ©nÃ©rÃ©, tu dois le stocker en **secret GitHub Actions** :

â¡ï¸ Ã‰tapes :

1. Aller dans ton dÃ©pÃ´t `produits-cms-ui` â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**.
2. Ajouter un secret nommÃ© par ex. :
    - `DEPLOY_PAT` = ton token GitHub.
3. Dans ton `curl`, utilise ce token :
    

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $DEPLOY_PAT" \
  https://api.github.com/repos/Collect-Verything/produits-cms-ui/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```
---

## 6.5. VÃ©rifications et checks utiles

Quand on configure un PAT et quâ€™on a des erreurs, il existe plusieurs requÃªtes **de diagnostic** Ã  lancer avec `curl`.

### ğŸ”¹ VÃ©rifier lâ€™accÃ¨s au repo (lecture simple)

```bash
curl -H "Authorization: Bearer <TOKEN>" \
  https://api.github.com/repos/Collect-Verything/produits-cms-ui
```

ğŸ‘‰ RÃ©sultats possibles :

- `200 OK` â†’ le token a bien accÃ¨s au repo.
- `404 Not Found` â†’ le repo est privÃ© OU le token nâ€™a pas accÃ¨s Ã  ce repo.
- `401 Unauthorized` â†’ token invalide ou expirÃ©.
    

---

### ğŸ”¹ VÃ©rifier que le token est valide (test API basique)

```bash
curl -H "Authorization: Bearer <TOKEN>" https://api.github.com/user
```

ğŸ‘‰ RÃ©sultats possibles 
- Retourne un JSON avec ton `login` â†’ âœ… le token est valide.
- `401 Unauthorized` â†’ token incorrect ou expirÃ©.
    

---

### ğŸ”¹ Tester lâ€™Ã©vÃ©nement `repository_dispatch`

Câ€™est la commande finale pour dÃ©clencher le workflow :

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <TOKEN>" \
  https://api.github.com/repos/Collect-Verything/produits-cms-ui/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```

ğŸ‘‰ RÃ©sultats possibles :

- `204 No Content` â†’ succÃ¨s (lâ€™Ã©vÃ©nement a Ã©tÃ© crÃ©Ã©).
- `403 Resource not accessible by personal access token` â†’ permissions manquantes (`Actions` ou `Contents`).
- `404 Not Found` â†’ repo privÃ© inaccessible â†’ revoir owner et accÃ¨s.
    

---

### ğŸ”¹ PiÃ¨ges rencontrÃ©s dans ton cas

1. **404 au dÃ©but** â†’ le repo Ã©tait privÃ© â†’ le token nâ€™Ã©tait pas liÃ© Ã  lâ€™organisation.
2. **401 ensuite** â†’ mauvais token / expirÃ©.
3. **403 aprÃ¨s coup** â†’ permissions du PAT pas suffisantes (il manquait `Actions: Read and write`).
    

Une fois corrigÃ© â†’ `204 No Content` â†’ workflow bien dÃ©clenchÃ© âœ….

----
## âœ… RÃ©sumÃ© complet : PAT GitHub & erreurs courantes

- Un **PAT (Personal Access Token)** est **obligatoire** pour accÃ©der Ã  un repo **privÃ©** et dÃ©clencher un Ã©vÃ©nement `repository_dispatch`.
    
- **VÃ©rifications rapides Ã  faire avec `curl`** :
    
    - `GET /user` â†’ vÃ©rifie si le token est valide.
    - `GET /repos/:owner/:repo` â†’ vÃ©rifie si le token a accÃ¨s au repo.
    - `POST /repos/:owner/:repo/dispatches` â†’ teste le dÃ©clenchement du workflow.
        
- **Erreurs classiques rencontrÃ©es** :
    
    - **404 Not Found** â†’ le repo est privÃ© ou le token nâ€™a pas accÃ¨s Ã  lâ€™organisation.
    - **401 Unauthorized** â†’ token invalide ou expirÃ©.
    - **403 Resource not accessible by PAT** â†’ permissions insuffisantes (rÃ©solu en activant `Actions: Read and write`).
        
- **Permissions minimales Ã  donner au PAT** :
    
    - Repository â†’ **Actions: Read and write** âœ…
    - Repository â†’ **Contents: Read and write** âœ…
    - Repository â†’ **Metadata: Read-only** (par dÃ©faut) âœ…
        
- Avec un **PAT fine-grained bien configurÃ©** :
    
    - Le `repository_dispatch` peut Ãªtre dÃ©clenchÃ© depuis ton **frontend** (via `fetch` ou `axios`) ou un simple `curl`.
    - Le workflow GitHub reÃ§oit le `client_payload` et lance le **build + push + deploy** Docker automatiquement.
        

---

âš¡ GrÃ¢ce Ã  ces rÃ¨gles, tu as une **procÃ©dure de debug complÃ¨te** pour identifier et corriger toute erreur (`401`, `403`, `404`) et ne plus Ãªtre bloquÃ© sur les Bearer Tokens GitHub.


---

# ğŸ”„ SchÃ©ma du flux CI/CD avec PAT GitHub

```
[ Frontend / Client ]
         |
         |  (fetch / axios / curl)
         |  Envoi JSON (client_payload) + PAT
         v
[ API GitHub - repository_dispatch ]
         |
         |  VÃ©rifie le PAT :
         |   - Token valide ? âœ…
         |   - AccÃ¨s au repo ? âœ…
         |   - Permissions suffisantes ? âœ…
         v
[ GitHub Actions Workflow (deploy.yml) ]
         |
         |  Ã‰tapes :
         |   1. Checkout code
         |   2. Build image Docker (--build-arg avec client_payload)
         |   3. Push image sur Docker Hub
         |   4. SSH vers VPS
         |   5. docker run (Nginx)
         v
[ Docker Hub Registry ]
         |
         |  Image disponible : namespace/client-cms-<user>
         v
[ VPS / Serveur Ionos ]
         |
         |  docker run -p 80:8080
         v
[ Application React (Nginx) ]
   => http://<IP_SERVEUR>/
```

---

## âœ… Lecture rapide

1. **Frontend** â†’ envoie une requÃªte POST avec le **Bearer Token** et le **payload**.
2. **GitHub API** â†’ valide le PAT et dÃ©clenche lâ€™Ã©vÃ©nement `repository_dispatch`.
3. **GitHub Actions** â†’ build lâ€™image Docker personnalisÃ©e, push sur Docker Hub et dÃ©ploie via SSH.
4. **Docker Hub** â†’ stocke lâ€™image (taggÃ©e dynamiquement par utilisateur).
5. **VPS** â†’ rÃ©cupÃ¨re lâ€™image, lance le conteneur et expose lâ€™app sur le port 80.
    
