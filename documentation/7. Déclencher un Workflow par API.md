

GitHub propose un mÃ©canisme spÃ©cial pour dÃ©clencher un workflow en dehors de GitHub UI ou des Ã©vÃ©nements Git standards :  
lâ€™**Ã©vÃ©nement `repository_dispatch`**.  
Cet Ã©vÃ©nement est invoquÃ© via lâ€™API REST de GitHub en envoyant une requÃªte POST sur lâ€™endpoint `/dispatches`.

---

## 7.1. Endpoint GitHub REST API `/dispatches`

- URL gÃ©nÃ©rale :
    

```
POST https://api.github.com/repos/:owner/:repo/dispatches
```

- Headers obligatoires :
    
    - `Accept: application/vnd.github+json`
        
    - `Authorization: Bearer <PAT>`
        
- Body attendu :
    

```json
{
  "event_type": "nom-evenement",
  "client_payload": {
    "clÃ©1": "valeur1",
    "clÃ©2": "valeur2"
  }
}
```

ğŸ‘‰ Ici :

- `event_type` doit correspondre Ã  ce que tu as dÃ©fini dans ton `on.repository_dispatch.types` du workflow (`deploy-site` dans ton cas).
    
- `client_payload` est un objet libre qui sera injectÃ© dans le workflow (accessible via `github.event.client_payload`).
    

---

## 7.2. Exemple de requÃªte `curl` (avec `client_payload`)

Exemple concret adaptÃ© Ã  ton projet :

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <DEPLOY_PAT>" \
  https://api.github.com/repos/Collect-Verything/produits-cms-ui/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```

ğŸ‘‰ Points importants :

- `<DEPLOY_PAT>` doit Ãªtre un **Personal Access Token (PAT)** correctement configurÃ© (voir fiche **6. Bearer Token GitHub**).
    
- `user` sert Ã  gÃ©nÃ©rer un nom unique dâ€™image Docker et de conteneur (`client-cms-usertest`).
    
- La rÃ©ponse de lâ€™API ne contient pas de dÃ©tails â†’ il faut analyser le **code HTTP** pour savoir ce qui sâ€™est passÃ©.
    

---

## 7.3. VÃ©rification des rÃ©ponses HTTP

GitHub API ne renvoie pas de corps dÃ©taillÃ© sur `/dispatches`, seulement un **status code**.  
Voici les cas possibles :

- **204 No Content âœ…**
    
    - Le workflow a bien Ã©tÃ© dÃ©clenchÃ©.
        
    - Tu peux vÃ©rifier dans **Actions â†’ onglet workflow** sur GitHub que le job sâ€™exÃ©cute.
        
- **401 Unauthorized âŒ**
    
    - Ton PAT est invalide ou expirÃ©.
        
    - VÃ©rifie la fiche **6. Bearer Token GitHub (6.5 VÃ©rifications)** â†’ utilise `curl https://api.github.com/user` pour tester le token.
        
- **403 Forbidden âŒ**
    
    - Ton PAT nâ€™a pas les bonnes permissions.
        
    - Voir fiche **6.3 Droits & permissions minimales** â†’ il faut `Actions: Read and write` et `Contents: Read and write`.
        
- **404 Not Found âŒ**
    
    - Le repo est privÃ© ou lâ€™owner est incorrect.
        
    - VÃ©rifie :
        
        - le bon **namespace** (`Collect-Verything` et pas ton compte perso).
            
        - que ton PAT a bien accÃ¨s au repo (voir fiche **6.5 VÃ©rifications et checks utiles**).
            

---

## âœ… RÃ©sumÃ©

- Lâ€™endpoint `/dispatches` permet de **dÃ©clencher un workflow par API**.
    
- Tu dois fournir un **PAT valide** + un **event_type** correspondant.
    
- Les variables envoyÃ©es dans `client_payload` sont directement exploitables dans ton workflow (`github.event.client_payload.*`).
    
- Les rÃ©ponses HTTP (`204`, `401`, `403`, `404`) permettent de diagnostiquer rapidement â†’ se rÃ©fÃ©rer Ã  la fiche **6. Bearer Token GitHub** pour rÃ©soudre les cas dâ€™erreurs.
    

---

âš¡ En pratique : **204** = succÃ¨s, tout le reste â†’ problÃ¨me de token, repo ou permissions.
