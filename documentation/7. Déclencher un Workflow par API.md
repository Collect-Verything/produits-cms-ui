

GitHub propose un m√©canisme sp√©cial pour d√©clencher un workflow en dehors de GitHub UI ou des √©v√©nements Git standards :  
l‚Äô**√©v√©nement `repository_dispatch`**.  
Cet √©v√©nement est invoqu√© via l‚ÄôAPI REST de GitHub en envoyant une requ√™te POST sur l‚Äôendpoint `/dispatches`.

---

## 7.1. Endpoint GitHub REST API `/dispatches`

- URL g√©n√©rale :
    

```
POST https://api.github.com/repos/:owner/:repo/dispatches
```

- Headers obligatoires :
    
    - `Accept: application/vnd.github+json`
        
    - `Authorization: Bearer <PAT>`
        
- Body attendu :
    

```json
{
  "event_type": "nom-evenement",
  "client_payload": {
    "cl√©1": "valeur1",
    "cl√©2": "valeur2"
  }
}
```

üëâ Ici :

- `event_type` doit correspondre √† ce que tu as d√©fini dans ton `on.repository_dispatch.types` du workflow (`deploy-site` dans ton cas).
    
- `client_payload` est un objet libre qui sera inject√© dans le workflow (accessible via `github.event.client_payload`).
    

---

## 7.2. Exemple de requ√™te `curl` (avec `client_payload`)

Exemple concret adapt√© √† ton projet :

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer <DEPLOY_PAT>" \
  https://api.github.com/repos/Collect-Verything/produits-cms-ui/dispatches \
  -d '{
    "event_type": "deploy-site",
    "client_payload": {
      "primary": "#f542c2",
      "secondary": "#fcba03",
      "titreSite": "titretest",
      "user": "usertest"
    }
  }'
```

üëâ Points importants :

- `<DEPLOY_PAT>` doit √™tre un **Personal Access Token (PAT)** correctement configur√© (voir fiche **6. Bearer Token GitHub**).
    
- `user` sert √† g√©n√©rer un nom unique d‚Äôimage Docker et de conteneur (`client-cms-usertest`).
    
- La r√©ponse de l‚ÄôAPI ne contient pas de d√©tails ‚Üí il faut analyser le **code HTTP** pour savoir ce qui s‚Äôest pass√©.
    

---

## 7.3. V√©rification des r√©ponses HTTP

GitHub API ne renvoie pas de corps d√©taill√© sur `/dispatches`, seulement un **status code**.  
Voici les cas possibles :

- **204 No Content ‚úÖ**
    
    - Le workflow a bien √©t√© d√©clench√©.
        
    - Tu peux v√©rifier dans **Actions ‚Üí onglet workflow** sur GitHub que le job s‚Äôex√©cute.
        
- **401 Unauthorized ‚ùå**
    
    - Ton PAT est invalide ou expir√©.
        
    - V√©rifie la fiche **6. Bearer Token GitHub (6.5 V√©rifications)** ‚Üí utilise `curl https://api.github.com/user` pour tester le token.
        
- **403 Forbidden ‚ùå**
    
    - Ton PAT n‚Äôa pas les bonnes permissions.
        
    - Voir fiche **6.3 Droits & permissions minimales** ‚Üí il faut `Actions: Read and write` et `Contents: Read and write`.
        
- **404 Not Found ‚ùå**
    
    - Le repo est priv√© ou l‚Äôowner est incorrect.
        
    - V√©rifie :
        
        - le bon **namespace** (`Collect-Verything` et pas ton compte perso).
            
        - que ton PAT a bien acc√®s au repo (voir fiche **6.5 V√©rifications et checks utiles**).
            

---

## ‚úÖ R√©sum√©

- L‚Äôendpoint `/dispatches` permet de **d√©clencher un workflow par API**.
    
- Tu dois fournir un **PAT valide** + un **event_type** correspondant.
    
- Les variables envoy√©es dans `client_payload` sont directement exploitables dans ton workflow (`github.event.client_payload.*`).
    
- Les r√©ponses HTTP (`204`, `401`, `403`, `404`) permettent de diagnostiquer rapidement ‚Üí se r√©f√©rer √† la fiche **6. Bearer Token GitHub** pour r√©soudre les cas d‚Äôerreurs.
    

---

‚ö° En pratique : **204** = succ√®s, tout le reste ‚Üí probl√®me de token, repo ou permissions.

---

Veux-tu que je te fasse aussi un **exemple √©quivalent en `fetch` c√¥t√© frontend** (comme si ton app React d√©clenchait directement le workflow) ?