

En mode **dÃ©veloppement**, lâ€™objectif est de pouvoir coder dans lâ€™application React et voir les changements **instantanÃ©ment** grÃ¢ce au hot reload.  
Pour cela, on nâ€™utilise pas Nginx mais directement le serveur de dÃ©veloppement fourni par **Create React App** (`react-scripts start` => *CRA*) .

---

## ğŸ”¹ Contenu du `Dockerfile.dev`

```dockerfile
# ===========================
# Dev: React avec hot reload
# ===========================
ARG NODE_VERSION=22.14.0-alpine
FROM node:${NODE_VERSION}

WORKDIR /app

# Installer les dÃ©pendances
COPY package.json package-lock.json ./
RUN --mount=type=cache,target=/root/.npm npm ci

# Copier le reste du code
COPY . .

# Important : Ã©couter sur toutes les interfaces
ENV HOST=0.0.0.0
EXPOSE 3000

# Lancer le serveur de dev (CRA)
CMD ["npm", "start"]
```
### ğŸ”¹ DÃ©composition

##### 1. `--mount=type=cache,target=/root/.npm`

- Câ€™est une **option avancÃ©e de BuildKit** (le moteur de build de Docker).
- Elle crÃ©e un **cache persistant** qui survit aux builds successifs.
- Ici, le cache est stockÃ© dans `/root/.npm`, câ€™est-Ã -dire lÃ  oÃ¹ `npm` garde ses paquets tÃ©lÃ©chargÃ©s.

ğŸ‘‰ RÃ©sultat : lors des prochains `docker build`, npm ne retÃ©lÃ©charge pas toutes les dÃ©pendances â†’ build **beaucoup plus rapide**.
âš ï¸ Attention : ce cache est **local au builder**. Si tu build sur GitHub Actions, le cache y sera diffÃ©rent de ta machine locale.

---

##### 2. `npm ci`

- `npm ci` = _clean install_.
- Contrairement Ã  `npm install`, il se base **strictement** sur le fichier `package-lock.json`.
- Avantages :
    - **ReproductibilitÃ© garantie** â†’ toujours les mÃªmes versions de dÃ©pendances.
    - **Plus rapide** â†’ supprime `node_modules` et rÃ©installe directement ce qui est listÃ©.
    - IdÃ©al pour les **CI/CD pipelines** et builds en Docker.

Source : https://docs.npmjs.com/cli/v9/commands/npm-ci
        
---

##### ğŸ”¹ Exemple de workflow

Sans cache + `npm install` â†’ Ã  chaque build :
1. Docker tÃ©lÃ©charge toutes les dÃ©pendances depuis zÃ©ro.
2. Le build prend beaucoup de temps.
Avec cache + `npm ci` â†’
3. Docker rÃ©utilise les paquets dÃ©jÃ  tÃ©lÃ©chargÃ©s (si pas de changement dans `package-lock.json`).
4. Build quasi instantanÃ©.

---
##### ğŸ”¹ RÃ©sumÃ©

Cette ligne :

```dockerfile
RUN --mount=type=cache,target=/root/.npm npm ci
```

- **Optimise** le build en mettant en cache les paquets NPM.
- **Garantit** que le build utilise exactement les dÃ©pendances dÃ©finies dans `package-lock.json`.
- Est particuliÃ¨rement utile en **CI/CD** (GitHub Actions, etc.).
    

---
#### âš–ï¸ Comparatif `npm install` vs `npm ci` (avec/sans cache)

| Commande                | Comportement                                                                                  | RapiditÃ©                                              | ReproductibilitÃ©                         | Cas dâ€™usage recommandÃ©                                      |
| ----------------------- | --------------------------------------------------------------------------------------------- | ----------------------------------------------------- | ---------------------------------------- | ----------------------------------------------------------- |
| **npm install**         | Installe les dÃ©pendances listÃ©es dans `package.json`. Peut mettre Ã  jour `package-lock.json`. | â³ Plus lent (rÃ©solution des versions Ã  chaque build). | âŒ Pas garanti (versions peuvent varier). | DÃ©veloppement local, quand tu ajoutes ou modifies des libs. |
| **npm ci**              | Supprime `node_modules` puis installe **exactement** les dÃ©pendances de `package-lock.json`.  | âš¡ Plus rapide que `install`.                          | âœ… Toujours identique (versions figÃ©es).  | CI/CD, builds Docker, prod.                                 |
| **npm install + cache** | Les paquets tÃ©lÃ©chargÃ©s sont rÃ©utilisÃ©s au prochain build.                                    | â³ Toujours plus lent que `ci` (rÃ©solution).           | âŒ Toujours non figÃ©.                     | Rarement utile.                                             |
| **npm ci + cache**      | RÃ©utilise les paquets dÃ©jÃ  tÃ©lÃ©chargÃ©s **et** suit strictement `package-lock.json`.           | ğŸš€ Ultra rapide.                                      | âœ… Garanti.                               | â­ Meilleur choix pour Docker + CI/CD.                       |

---

##### âœ… Conclusion pour Docker

La ligne :
```dockerfile
RUN --mount=type=cache,target=/root/.npm npm ci
```
combine **le meilleur des deux mondes** :
- `npm ci` â†’ installation fiable et reproductible
- `--mount=cache` â†’ build rapide, mÃªme aprÃ¨s plusieurs exÃ©cutions
    

---

## ğŸ”¹ Explications

- **HOST=0.0.0.0** : obligatoire pour que lâ€™app soit accessible depuis lâ€™extÃ©rieur du conteneur (sinon elle reste accessible uniquement en `localhost` interne).
- **EXPOSE 3000** : CRA Ã©coute sur le port 3000 en mode dev.
- **npm start** : dÃ©marre le serveur de dev avec hot reload.
- On utilise `npm ci` plutÃ´t que `npm install` pour garantir une installation reproductible des dÃ©pendances (basÃ©e sur `package-lock.json`).

---

## ğŸ”¹ Utilisation avec docker-compose

Dans `compose.yaml` :

```yaml
client-dev:
  build:
    context: .
    dockerfile: Dockerfile.dev
  ports:
    - 3000:3000
  volumes:
    - .:/app
    - /app/node_modules
  environment:
    NODE_ENV: development
    HOST: 0.0.0.0
```

- **.:/app** â†’ monte ton code source dans le conteneur
- **/app/node_modules** â†’ Ã©vite les conflits entre dÃ©pendances locales et celles du conteneur

---

## ğŸ”¹ Commandes utiles

### Lancer le service dev avec hot reload :

```bash
docker compose up client-dev
```

ğŸ‘‰ Application accessible sur : [http://localhost:3000](http://localhost:3000/)

---

âœ… Ce `Dockerfile.dev` est donc dÃ©diÃ© uniquement au **dÃ©veloppement**, contrairement au `Dockerfile` classique qui sert la version optimisÃ©e avec Nginx.
